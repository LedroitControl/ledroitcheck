<!doctype html>
<html lang="es" data-include-header="true">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menú — LEDROITCHECK</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="icon" type="image/svg+xml" href="assets/logo-ledroitcheck.svg" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- Header global desde documentación -->
  <link rel="stylesheet" href="assets/global-header.css" />
  <!-- SDK Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Carga secuencial con versión estable desde version.json
    (function(){
      function appendVersion(url, v){
        return url + (url.indexOf('?') === -1 ? ('?v=' + v) : ('&v=' + v));
      }
      function loadScript(src, cb){
        var s = document.createElement('script');
        s.src = src;
        s.onload = function(){ cb && cb(); };
        document.head.appendChild(s);
      }
      fetch('version.json?v=' + Date.now())
        .then(function(r){ return r.ok ? r.json() : { version: Date.now().toString() }; })
        .then(function(info){
          var v = info.version || info.build || Date.now().toString();
          // Actualizar hojas de estilo con versión
          var links = document.querySelectorAll('link[rel="stylesheet"]');
          links.forEach(function(link){
            if (/\b(main\.css|global-header\.css)\b/.test(link.getAttribute('href'))){
              link.href = appendVersion(link.href, v);
            }
          });
          // Cargar scripts de la app con versión
          loadScript(appendVersion('firebase-config.js', v), function(){
            loadScript(appendVersion('assets/global-header.js', v), function(){
              loadScript(appendVersion('assets/session-manager.js', v), function(){
                loadScript(appendVersion('js/ingresos-activos.js', v));
              });
            });
          });
          // Mostrar badge de versión
          var el = document.getElementById('versionBadge');
          if (el) { el.textContent = 'Versión del sitio: ' + 'version' + v; }
        })
        .catch(function(){
          // Si falla, cargar sin versión
          loadScript('firebase-config.js', function(){
            loadScript('assets/global-header.js', function(){
              loadScript('assets/session-manager.js', function(){
                loadScript('js/ingresos-activos.js');
              });
            });
          });
        });
    })();
  </script>
</head>
<body>
  <script>
    // Guardia de sesión: si no hay sesión, ir a login
    (function(){
      try{
        const s = sessionStorage.getItem('ls_session');
        const ses = s ? JSON.parse(s) : null;
        if (!ses || !ses.iniciales) {
          window.location.replace('login.html');
        }
      }catch(e){ window.location.replace('login.html'); }
    })();
  </script>
  <!-- Página sin contenido: solo header y modal BIENVENIDA -->
  <div id="versionBadge" class="muted" style="font-size:12px;margin:8px 16px"></div>
  <div id="userInfo" class="row" style="margin:0 16px"></div>

  <script type="module">
    try {
      const s = sessionStorage.getItem('ls_session');
      const ses = s ? JSON.parse(s) : null;
      const $userInfo = document.getElementById('userInfo');
      if (ses) {
        $userInfo.innerHTML = `
          <div class="col">
            <strong>Iniciales:</strong> ${ses.iniciales || ''}
          </div>
          <div class="col">
            <strong>Nombre:</strong> ${ses.nombre || ''}
          </div>
          <div class="col">
            <strong>Empresa activa:</strong> ${ses.empresa_activa || '(no definida)'}
          </div>
        `;
        // Notificar al header global con estructura esperada por la guía
          window.ledroitAuth = {
          user: {
            nombre: ses.nombre || '',
            foto_url: ses.foto_url || null,
            empresas: Array.isArray(ses.empresas) ? ses.empresas : []
          },
          iniciales: ses.iniciales || ''
        };
        window.dispatchEvent(new CustomEvent('sessionChanged', { detail: window.ledroitAuth }));
        // Guardar sesión en sessionStorage para compatibilidad del gadget
        try {
          sessionStorage.setItem('ledroitAuth', JSON.stringify(window.ledroitAuth));
        } catch (e) {}
        // No usar claves no estándar; el gadget usa ledroitAuth/ls_session
      } else {
        $userInfo.innerHTML = '<p class="muted">No hay sesión activa. <a href="login.html">Ingresar</a></p>';
      }
    } catch (e) { console.warn('No se pudo leer ls_session:', e); }
  </script>

  <!-- Fase 2: Modal BIENVENIDA profesional -->
  <script type="module">
    import { showToast } from './js/toast.js';

    async function waitForFirestoreManager(timeout = 10000){
      const start = Date.now();
      return new Promise((resolve, reject) => {
        const iv = setInterval(() => {
          if (window.firestoreManager && typeof window.firestoreManager.getJornadaAbierta === 'function' && typeof window.openJornada === 'function' && typeof window.closeJornada === 'function'){
            clearInterval(iv);
            resolve(window.firestoreManager);
          } else if (Date.now() - start > timeout){
            clearInterval(iv);
            reject(new Error('firestoreManager_timeout'));
          }
        }, 50);
      });
    }

    function isMobileUA(){
      const ua = navigator.userAgent || navigator.vendor || window.opera || '';
      return /android|iphone|ipad|ipod|iemobile|blackberry|mobile/i.test(ua);
    }

    function getEmpresaActivas(ses){
      const arr = Array.isArray(ses?.empresas) ? ses.empresas : [];
      // Filtrar empresas activas y usuario activo
      return arr.filter(e => e?.empresa_activa && e?.usuario_activo !== false);
    }

    function setEmpresaSeleccionadaEnSesion(nombreEmpresa, roles){
      try {
        const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
        if (!s) return;
        const ses = JSON.parse(s);
        ses.empresaSeleccionada = { nombre: nombreEmpresa, rol: Array.isArray(roles) ? roles : [] };
        const storage = sessionStorage.getItem('ls_session') ? sessionStorage : localStorage;
        storage.setItem('ls_session', JSON.stringify(ses));
        // Notificar al header (fase 3 mostrará en UI)
        window.dispatchEvent(new CustomEvent('empresaSeleccionadaChanged', { detail: ses.empresaSeleccionada }));
      } catch {}
    }

    function solicitarUbicacion(timeout = 10000) {
      return new Promise(resolve => {
        if (!('geolocation' in navigator)) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude, accuracy } = pos.coords || {};
            resolve({ lat: latitude || null, lng: longitude || null, accuracy: accuracy || null });
          },
          _err => resolve(null),
          { enableHighAccuracy: true, timeout }
        );
      });
    }

    async function obtenerIP(){
      try{
        const r = await fetch('https://api.ipify.org?format=json');
        const j = await r.json();
        return j.ip || null;
      }catch(_){ return null; }
    }

    function formatoTiempo(ms){
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function crearBackdrop(){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.innerHTML = `<div class="modal" role="dialog" aria-modal="true"></div>`;
      document.body.appendChild(backdrop);
      setTimeout(() => backdrop.classList.add('show'), 30);
      return backdrop;
    }

    function renderBienvenida(backdrop, ses, estado){
      const modal = backdrop.querySelector('.modal');
      const nombre = ses?.nombre || '';
      const iniciales = ses?.iniciales || '';
      const foto = ses?.foto_url || '';
      const activas = getEmpresaActivas(ses);
      const empresaSel = ses?.empresaSeleccionada?.nombre || null;
      const isMobile = isMobileUA();

      const avatarHtml = foto ? `<img src="${foto}" alt="avatar" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--border)"/>`
                               : `<div style="width:64px;height:64px;border-radius:50%;background:#eef;display:flex;align-items:center;justify-content:center;font-weight:700;color:#334">${iniciales||'??'}</div>`;

      const botonesPaginas = (() => {
        const roles = (activas.find(e => e?.nombre === empresaSel)?.rol) || [];
        const puedeAdmin = Array.isArray(roles) && roles.some(r => r==='A1' || r==='A2');
        if (!puedeAdmin) return '';
        return `
          <div class="actions" style="margin-top:12px">
            <a class="btn secondary" href="configuracion.html">Configuración</a>
            <a class="btn secondary" href="configuracionmaster.html">Configuración Maestra</a>
            <a class="btn secondary" href="nomina.html">Nómina</a>
          </div>
        `;
      })();

      function renderSelector(){
        const botones = activas.map(e => `<button class="btn" data-empresa="${e.nombre}">${e.nombre}</button>`).join(' ');
        return `
          <h3 style="margin:0 0 8px">Bienvenido</h3>
          <div style="display:flex;gap:12px;align-items:center">
            ${avatarHtml}
            <div>
              <div style="font-weight:700">${nombre}</div>
              <div class="muted" style="font-size:12px">Iniciales: ${iniciales}</div>
            </div>
          </div>
          <div style="margin-top:12px">
            <p class="muted">Selecciona la empresa con la que trabajarás:</p>
            <div class="actions" id="selectorEmpresas">${botones}</div>
          </div>
        `;
      }

      function renderJornadaCerrada(){
        const ahoraId = 'relojAhora';
        return `
          <h3 style="margin:0 0 8px">Bienvenido</h3>
          <div style="display:flex;gap:12px;align-items:center">
            ${avatarHtml}
            <div>
              <div style="font-weight:700">${nombre}</div>
              <div class="muted" style="font-size:12px">Iniciales: ${iniciales}</div>
              <div class="muted" style="font-size:12px">Empresa: ${empresaSel||'(selecciona)'}</div>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;align-items:center;gap:10px">
            <div style="font-size:20px;font-weight:700">Reloj:</div>
            <div id="${ahoraId}" style="font-family:monospace;font-size:20px">--:--:--</div>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn" id="btnAbrir">Abrir Jornada</button>
          </div>
          ${botonesPaginas}
        `;
      }

      function renderJornadaAbierta(info){
        const inicio = info?.horaEntrada && info.horaEntrada.toDate ? info.horaEntrada.toDate() : new Date();
        const inicioISO = inicio.toLocaleString();
        const timerId = 'timerJornada';
        return `
          <h3 style="margin:0 0 8px">JORNADA ABIERTA</h3>
          <div style="display:flex;gap:12px;align-items:center">
            ${avatarHtml}
            <div>
              <div style="font-weight:700">${nombre}</div>
              <div class="muted" style="font-size:12px">Iniciales: ${iniciales}</div>
              <div class="muted" style="font-size:12px">Empresa: ${empresaSel||'(selecciona)'}</div>
            </div>
          </div>
          <div style="margin-top:12px">
            <div class="muted" style="font-size:12px">Entrada: ${inicioISO}</div>
            <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
              <div style="font-size:20px;font-weight:700">Tiempo en jornada:</div>
              <div id="${timerId}" style="font-family:monospace;font-size:20px">00:00:00</div>
            </div>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn" id="btnCerrar">Cerrar Jornada</button>
          </div>
          ${botonesPaginas}
        `;
      }

      // Decidir modo
      const modo = estado.modo; // 'selector' | 'cerrada' | 'abierta'
      if (modo === 'selector') {
        modal.innerHTML = renderSelector();
        // Eventos selector
        const cont = modal.querySelector('#selectorEmpresas');
        cont.querySelectorAll('button[data-empresa]').forEach(btn => {
          btn.addEventListener('click', () => {
            const nombreEmp = btn.getAttribute('data-empresa');
            const roles = activas.find(e => e?.nombre === nombreEmp)?.rol || [];
            setEmpresaSeleccionadaEnSesion(nombreEmp, roles);
            showToast('Empresa seleccionada: ' + nombreEmp, 'success');
            // Re-render a jornada cerrada
            renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo: 'cerrada' });
            iniciarReloj(modal.querySelector('#relojAhora'));
            bindAbrir(modal.querySelector('#btnAbrir'), nombreEmp);
          });
        });
      } else if (modo === 'cerrada') {
        modal.innerHTML = renderJornadaCerrada();
        iniciarReloj(modal.querySelector('#relojAhora'));
        const nombreEmp = empresaSel || (activas.length===1 ? activas[0].nombre : null);
        bindAbrir(modal.querySelector('#btnAbrir'), nombreEmp);
      } else if (modo === 'abierta') {
        modal.innerHTML = renderJornadaAbierta(estado.info);
        iniciarTimer(modal.querySelector('#timerJornada'), estado.info?.horaEntrada);
        bindCerrar(modal.querySelector('#btnCerrar'));
      }

      function iniciarReloj(el){
        if (!el) return;
        const tick = () => {
          const d = new Date();
          el.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        };
        tick();
        const iv = setInterval(tick, 1000);
        backdrop._clockInterval = iv;
      }
      function iniciarTimer(el, ts){
        if (!el) return;
        const inicio = ts && ts.toDate ? ts.toDate().getTime() : Date.now();
        const tick = () => { el.textContent = formatoTiempo(Date.now() - inicio); };
        tick();
        const iv = setInterval(tick, 1000);
        backdrop._timerInterval = iv;
      }

      async function bindAbrir(btn, nombreEmp){
        if (!btn) return;
        btn.addEventListener('click', async () => {
          try {
            if (!nombreEmp){ showToast('Selecciona una empresa', 'warning'); return; }
            const isMob = isMobile;
            let ubic = null;
            if (isMob){
              ubic = await solicitarUbicacion();
              if (!ubic){ showToast('Se requiere ubicación para abrir jornada en móvil', 'error'); return; }
            }
            const dispositivo = { isMobile: isMob };
            const ip = await obtenerIP();
            const resp = await window.openJornada(nombreEmp, ubic, dispositivo, ip);
            if (resp?.success){
              showToast('Jornada abierta', 'success');
              // Re-render modo abierta
              const openInfo = await window.firestoreManager.getJornadaAbierta(ses.iniciales);
              renderBienvenida(backdrop, ses, { modo:'abierta', info: openInfo });
              iniciarTimer(modal.querySelector('#timerJornada'), openInfo?.horaEntrada);
              bindCerrar(modal.querySelector('#btnCerrar'));
            } else {
              showToast('No se pudo abrir jornada: ' + (resp?.reason || 'error'), 'error');
            }
          } catch (e){ showToast('Error al abrir: ' + (e?.message || ''), 'error'); }
        });
      }

      async function bindCerrar(btn){
        if (!btn) return;
        btn.addEventListener('click', async () => {
          try {
            const isMob = isMobile;
            if (isMob){
              const ubic = await solicitarUbicacion();
              if (!ubic){ showToast('Se requiere ubicación para cerrar jornada en móvil', 'error'); return; }
            }
            const resp = await window.closeJornada();
            if (resp?.success){
              showToast('Jornada cerrada', 'success');
              // Tras cerrar: si hay múltiples empresas activas, forzar selector; si solo una, jornada cerrada
              const sesNow = JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session'));
              const activasNow = getEmpresaActivas(sesNow);
              if (activasNow.length > 1){
                // limpiar empresaSeleccionada para forzar nueva selección
                try { sesNow.empresaSeleccionada = null; sessionStorage.setItem('ls_session', JSON.stringify(sesNow)); } catch {}
                renderBienvenida(backdrop, sesNow, { modo:'selector' });
              } else {
                renderBienvenida(backdrop, sesNow, { modo:'cerrada' });
                iniciarReloj(modal.querySelector('#relojAhora'));
                const unica = activasNow[0];
                bindAbrir(modal.querySelector('#btnAbrir'), unica?.nombre || null);
              }
            } else {
              showToast('No se pudo cerrar jornada: ' + (resp?.reason || 'error'), 'error');
            }
          } catch (e){ showToast('Error al cerrar: ' + (e?.message || ''), 'error'); }
        });
      }
    }

    // Inicio: mostrar BIENVENIDA
    try {
      await waitForFirestoreManager(12000);
      const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
      const ses = s ? JSON.parse(s) : null;
      if (!ses || !ses.iniciales){
        // redirección ya la manejó el bloque anterior
      } else {
        const backdrop = crearBackdrop();
        const activas = getEmpresaActivas(ses);
        const openInfo = await window.firestoreManager.getJornadaAbierta(ses.iniciales);
        if (openInfo){
          // Set empresa seleccionada = empresa con jornada abierta
          const rolesOpen = (activas.find(e => e?.nombre === openInfo.empresaNombre)?.rol) || [];
          setEmpresaSeleccionadaEnSesion(openInfo.empresaNombre, rolesOpen);
          renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'abierta', info: openInfo });
          const el = backdrop.querySelector('#timerJornada');
          if (el) { const ts = openInfo?.horaEntrada; const inicio = ts && ts.toDate ? ts.toDate().getTime() : Date.now(); const tick = () => { el.textContent = formatoTiempo(Date.now() - inicio); }; tick(); backdrop._timerInterval = setInterval(tick,1000); }
        } else if (activas.length === 1){
          const unica = activas[0];
          setEmpresaSeleccionadaEnSesion(unica.nombre, unica.rol || []);
          renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'cerrada' });
          const el = backdrop.querySelector('#relojAhora');
          if (el) { const tick = () => { const d = new Date(); el.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }; tick(); backdrop._clockInterval = setInterval(tick, 1000); }
          const btn = backdrop.querySelector('#btnAbrir');
          if (btn) { bindAbrir(btn, unica.nombre); }
        } else {
          // No hay jornada abierta y hay múltiples empresas: forzar selector
          renderBienvenida(backdrop, ses, { modo:'selector' });
        }
      }
    } catch (e){ console.warn('No se pudo abrir BIENVENIDA:', e); showToast('Inicializando… intenta de nuevo en unos segundos', 'warning'); }
  </script>
  <!-- La versión se establece en el script de carga secuencial arriba -->
</body>
</html>