<!doctype html>
<html lang="es" data-include-header="true">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menú — LEDROITCHECK</title>
  <link rel="stylesheet" href="css/main.css" />
  <!-- Animaciones profesionales -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="icon" type="image/svg+xml" href="assets/logo-ledroitcheck.svg" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- Header global desde documentación -->
  <link rel="stylesheet" href="assets/global-header.css" />
  <!-- SDK Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Carga secuencial con versión estable desde version.json
    (function(){
      function appendVersion(url, v){
        return url + (url.indexOf('?') === -1 ? ('?v=' + v) : ('&v=' + v));
      }
      function loadScript(src, cb){
        var s = document.createElement('script');
        s.src = src;
        s.onload = function(){ cb && cb(); };
        document.head.appendChild(s);
      }
      fetch('version.json?v=' + Date.now())
        .then(function(r){ return r.ok ? r.json() : { version: Date.now().toString() }; })
        .then(function(info){
          var v = info.version || info.build || Date.now().toString();
          // Actualizar hojas de estilo con versión
          var links = document.querySelectorAll('link[rel="stylesheet"]');
          links.forEach(function(link){
            if (/\b(main\.css|global-header\.css)\b/.test(link.getAttribute('href'))){
              link.href = appendVersion(link.href, v);
            }
          });
          // Cargar scripts de la app con versión
          loadScript(appendVersion('firebase-config.js', v), function(){
            loadScript(appendVersion('assets/global-header.js', v), function(){
              loadScript(appendVersion('assets/session-manager.js', v), function(){
                loadScript(appendVersion('js/ingresos-activos.js', v));
              });
            });
          });
          // Mostrar badge de versión
          var el = document.getElementById('versionBadge');
          if (el) { el.textContent = 'Versión del sitio: ' + 'version' + v; }
        })
        .catch(function(){
          // Si falla, cargar sin versión
          loadScript('firebase-config.js', function(){
            loadScript('assets/global-header.js', function(){
              loadScript('assets/session-manager.js', function(){
                loadScript('js/ingresos-activos.js');
              });
            });
          });
        });
    })();
  </script>
</head>
<body>
  <script>
    // Guardia de sesión: si no hay sesión, ir a login
    (function(){
      try{
        const s = sessionStorage.getItem('ls_session');
        const ses = s ? JSON.parse(s) : null;
        if (!ses || !ses.iniciales) {
          window.location.replace('login.html');
        }
      }catch(e){ window.location.replace('login.html'); }
    })();
  </script>
  <!-- Página sin contenido: solo header y modal BIENVENIDA -->
  <!-- Eliminado panel redundante de iniciales/nombre/empresa activa -->
  <div id="versionBadge" class="muted" style="font-size:12px;margin:8px 16px"></div>

  <!-- Fase 2: Modal BIENVENIDA profesional -->
  <script type="module">
    import { showToast } from './js/toast.js';

    async function waitForFirestoreManager(timeout = 10000){
      const start = Date.now();
      return new Promise((resolve, reject) => {
        const iv = setInterval(() => {
          if (window.firestoreManager && typeof window.firestoreManager.getJornadaAbierta === 'function' && typeof window.openJornada === 'function' && typeof window.closeJornada === 'function'){
            clearInterval(iv);
            resolve(window.firestoreManager);
          } else if (Date.now() - start > timeout){
            clearInterval(iv);
            reject(new Error('firestoreManager_timeout'));
          }
        }, 50);
      });
    }

    function isMobileUA(){
      const ua = navigator.userAgent || navigator.vendor || window.opera || '';
      return /android|iphone|ipad|ipod|iemobile|blackberry|mobile/i.test(ua);
    }
    // Helpers globales reutilizables desde distintos bloques
    function showLoadingModal(text){
      const bd = document.createElement('div');
      bd.className = 'modal-backdrop';
      bd.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
          <h3>${text || 'Procesando…'}</h3>
          <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
            <div class="spinner" style="width:24px;height:24px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.9s linear infinite"></div>
            <div class="muted">Por favor espera…</div>
          </div>
        </div>`;
      document.body.appendChild(bd);
      setTimeout(() => bd.classList.add('show'), 20);
      return { close(){ bd.classList.remove('show'); setTimeout(()=>bd.remove(),140); } };
    }

    // Exponer helpers en window para usarlos desde distintos contextos
    window.showLoadingModal = showLoadingModal;
    window.bindAbrir = function(btn, nombreEmp){
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          await window.handleOpenJornada({ boton: btn, empresaNombre: nombreEmp });
        } catch (e) {
          showToast('Error al abrir: ' + (e?.message || ''), 'error');
        }
      });
    };
    window.bindCerrar = function(btn){
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          if (typeof window.handleCloseJornada === 'function') {
            await window.handleCloseJornada({ confirm: true });
          } else {
            // Fallback original
            btn.disabled = true; btn.setAttribute('aria-busy', 'true');
            const loading = window.showLoadingModal('Cerrando jornada…');
            const isMob = isMobileUA();
            if (isMob){
              const ubic = await solicitarUbicacion();
              if (!ubic){ showToast('Se requiere ubicación para cerrar jornada en móvil', 'error'); loading.close(); btn.disabled = false; btn.removeAttribute('aria-busy'); return; }
            }
            const resp = await window.closeJornada();
            loading.close(); btn.disabled = false; btn.removeAttribute('aria-busy');
            if (resp?.success){
              showToast('Jornada cerrada', 'success');
              const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
              const sesNow = s ? JSON.parse(s) : null;
              const activasNow = getEmpresaActivas(sesNow || {});
              const backdrop = window._welcomeBackdrop || crearBackdrop();
              window._welcomeBackdrop = backdrop;
              if (activasNow.length > 1){
                try { sesNow.empresaSeleccionada = null; sessionStorage.setItem('ls_session', JSON.stringify(sesNow)); } catch {}
                renderBienvenida(backdrop, sesNow, { modo:'selector' });
              } else {
                renderBienvenida(backdrop, sesNow, { modo:'cerrada' });
                const el = backdrop.querySelector('#relojAhora');
                if (el){ const tick = () => { const d = new Date(); el.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }; tick(); backdrop._clockInterval = setInterval(tick, 1000); }
                const unica = activasNow[0];
                window.bindAbrir(backdrop.querySelector('#btnAbrir'), unica?.nombre || null);
              }
            } else {
              showToast('No se pudo cerrar jornada: ' + (resp?.reason || 'error'), 'error');
            }
          }
        } catch (e){ showToast('Error al cerrar: ' + (e?.message || ''), 'error'); }
      });
    };

    // Flujo global para abrir jornada y sincronizar Header + Modal
    window.handleOpenJornada = async function({ boton, empresaNombre }){
      const btn = boton;
      if (!empresaNombre){ showToast('Selecciona una empresa', 'warning'); return; }
      if (btn){ btn.disabled = true; btn.setAttribute('aria-busy', 'true'); }
      const loading = window.showLoadingModal('Abriendo jornada…');
      try {
        const isMob = isMobileUA();
        let ubic = null;
        if (isMob){
          ubic = await solicitarUbicacion();
          if (!ubic){ showToast('Se requiere ubicación para abrir jornada en móvil', 'error'); return; }
        }
        const dispositivo = { isMobile: isMob };
        const ip = await obtenerIP();
        const resp = await window.openJornada(empresaNombre, ubic, dispositivo, ip);
        if (resp?.success){
          // Alinear selección de empresa con la jornada abierta
          try {
            const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
            const ses = s ? JSON.parse(s) : null;
            const activas = getEmpresaActivas(ses || {});
            const roles = (activas.find(e => e?.nombre === empresaNombre)?.rol) || [];
            setEmpresaSeleccionadaEnSesion(empresaNombre, roles);
          } catch {}
          showToast('Jornada abierta', 'success');
          // Notificar a todo el sitio para que actualice UI inmediatamente
          window.dispatchEvent(new CustomEvent('jornadaChanged', { detail: { status: 'open', empresaNombre } }));
        } else {
          showToast('No se pudo abrir jornada: ' + (resp?.reason || 'error'), 'error');
        }
      } finally {
        loading?.close?.();
        if (btn){ btn.disabled = false; btn.removeAttribute('aria-busy'); }
      }
    };

    function getEmpresaActivas(ses){
      const arr = Array.isArray(ses?.empresas) ? ses.empresas : [];
      // Filtrar empresas activas y usuario activo
      return arr.filter(e => e?.empresa_activa && e?.usuario_activo !== false);
    }

    function setEmpresaSeleccionadaEnSesion(nombreEmpresa, roles){
      try {
        const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
        if (!s) return;
        const ses = JSON.parse(s);
        ses.empresaSeleccionada = { nombre: nombreEmpresa, rol: Array.isArray(roles) ? roles : [] };
        const storage = sessionStorage.getItem('ls_session') ? sessionStorage : localStorage;
        storage.setItem('ls_session', JSON.stringify(ses));
        // Notificar al header (fase 3 mostrará en UI)
        window.dispatchEvent(new CustomEvent('empresaSeleccionadaChanged', { detail: ses.empresaSeleccionada }));
      } catch {}
    }

    function solicitarUbicacion(timeout = 10000) {
      return new Promise(resolve => {
        if (!('geolocation' in navigator)) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude, accuracy } = pos.coords || {};
            resolve({ lat: latitude || null, lng: longitude || null, accuracy: accuracy || null });
          },
          _err => resolve(null),
          { enableHighAccuracy: true, timeout }
        );
      });
    }

    async function obtenerIP(){
      try{
        const r = await fetch('https://api.ipify.org?format=json');
        const j = await r.json();
        return j.ip || null;
      }catch(_){ return null; }
    }

    function formatoTiempo(ms){
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    // Paleta por empresa (código de color consistente)
    function hslToHex(h, s, l){
      h = (h%360+360)%360; s/=100; l/=100;
      const c = (1 - Math.abs(2*l - 1)) * s;
      const x = c * (1 - Math.abs((h/60)%2 - 1));
      const m = l - c/2;
      let r=0,g=0,b=0;
      if (h<60){ r=c; g=x; b=0; }
      else if (h<120){ r=x; g=c; b=0; }
      else if (h<180){ r=0; g=c; b=x; }
      else if (h<240){ r=0; g=x; b=c; }
      else if (h<300){ r=x; g=0; b=c; }
      else { r=c; g=0; b=x; }
      const to255 = v => Math.round((v+m)*255);
      const hex = v => v.toString(16).padStart(2,'0');
      return `#${hex(to255(r))}${hex(to255(g))}${hex(to255(b))}`;
    }
    // Paleta de colores consistente con el header (variedad mejorada)
    function getCompanyPalette(nombre) {
      const name = String(nombre || '').trim();
      let hash = 2166136261;
      for (let i = 0; i < name.length; i++) {
        hash ^= name.charCodeAt(i);
        hash = (hash * 16777619) >>> 0;
      }
      let mixed = hash ^ (hash >>> 16);
      mixed = (mixed * 0x45d9f3b) >>> 0;
      mixed ^= (mixed >>> 13);
      let hue = Math.floor(((Math.sin(mixed) * 10000) % 1 + 1) % 1 * 360);
      if (hue >= 90 && hue <= 150) {
        hue = (hue + (mixed % 2 ? 60 : 100)) % 360;
      }
      const sat = 60 + (mixed % 36);
      const baseLight = 38 + ((mixed >>> 8) % 12);
      const primary = `hsl(${hue} ${sat}% ${baseLight}%)`;
      const primaryDark = `hsl(${hue} ${sat}% ${Math.max(20, baseLight-16)}%)`;
      return { primary, primaryDark, hue };
    }

    function crearBackdrop(){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop welcome-backdrop';
      // Modal con estado de carga inicial para evitar la "raya" en blanco
      backdrop.innerHTML = `
        <div class="modal modal-welcome animate__animated animate__zoomIn" role="dialog" aria-modal="true">
          <div class="loading-state" style="display:flex;align-items:center;justify-content:center;min-height:320px;">
            <div class="spinner" style="width:36px;height:36px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.9s linear infinite"></div>
          </div>
        </div>`;
      document.body.appendChild(backdrop);
      setTimeout(() => backdrop.classList.add('show'), 30);
      return backdrop;
    }

    function renderBienvenida(backdrop, ses, estado){
      const modal = backdrop.querySelector('.modal');
      // Guardar modo actual para evitar re-renderes tardíos que causan parpadeo
      try { backdrop.dataset.mode = estado && estado.modo ? String(estado.modo) : ''; } catch {}
      const nombre = ses?.nombre || '';
      const iniciales = ses?.iniciales || '';
      const foto = ses?.foto_url || '';
      const activas = getEmpresaActivas(ses);
      const empresaSel = ses?.empresaSeleccionada?.nombre || null;
      const isMobile = isMobileUA();

      const heroImage = foto ? `<img src="${foto}" alt="usuario" class="welcome-hero-image"/>`
                             : `<div class="welcome-hero-placeholder">${(iniciales||'??')}</div>`;

      const botonesPaginas = (() => {
        const roles = (activas.find(e => e?.nombre === empresaSel)?.rol) || [];
        const puedeAdmin = Array.isArray(roles) && roles.some(r => r==='A1' || r==='A2');
        if (!puedeAdmin) return '';
        return `
          <div class="actions actions-center" style="margin-top:12px">
            <a class="btn secondary" href="configuracion.html" title="Configuración">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2"/><path d="M19.4 15a7.97 7.97 0 000-6l2.1-1.2-2-3.5-2.4.9a8.03 8.03 0 00-5.9-2.4l-.4-2.5H9.2l-.4 2.5a8.03 8.03 0 00-5.9 2.4l-2.4-.9-2 3.5L1.6 9a7.97 7.97 0 000 6l-2.1 1.2 2 3.5 2.4-.9a8.03 8.03 0 005.9 2.4l.4 2.5h3.2l.4-2.5a8.03 8.03 0 005.9-2.4l2.4.9 2-3.5-2.1-1.2z" stroke="currentColor" stroke-width="2"/></svg>
              Configuración
            </a>
            <a class="btn secondary" href="configuracionmaster.html" title="Config. Maestra">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l8 4v6c0 5-8 10-8 10S4 17 4 12V6l8-4z" stroke="currentColor" stroke-width="2"/></svg>
              Configuración Maestra
            </a>
            <a class="btn secondary" href="nomina.html" title="Nómina">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16v12H4z" stroke="currentColor" stroke-width="2"/><path d="M8 10h8M8 14h8" stroke="currentColor" stroke-width="2"/></svg>
              Nómina
            </a>
          </div>
        `;
      })();

      function renderSelector(estado){
        const botones = activas.map(e => {
          const pal = getCompanyPalette(e.nombre);
          return `<button class="btn btn-company" data-empresa="${e.nombre}" style="--comp-color:${pal.primary};--comp-color-dark:${pal.primaryDark}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12l9-9 9 9" stroke="currentColor" stroke-width="2"/><path d="M4 21h16V10H4v11z" stroke="currentColor" stroke-width="2"/></svg>
            ${e.nombre}
          </button>`;
        }).join(' ');
        const avisoOpen = estado?.openInfo ? `<div class="notice-open">Jornada abierta en <strong>${estado.openInfo.empresaNombre}</strong>. No puedes abrir otra hasta cerrar.</div>` : '';
        const ultima = estado?.ultima || null;
        const ultimaHtml = ultima ? `
          <div class="welcome-last">
            <div class="last-title">Última jornada</div>
            <div class="last-grid">
              <div><span>Empresa:</span> <strong>${ultima.empresa}</strong></div>
              <div><span>Entrada:</span> ${ultima.horaEntrada.toLocaleString()}</div>
              <div><span>Salida:</span> ${ultima.horaSalida.toLocaleString()}</div>
              <div><span>Duración:</span> ${Math.max(0, Math.floor(ultima.duracionMs/3600000))}h ${Math.floor((ultima.duracionMs%3600000)/60000)}m</div>
            </div>
          </div>
        ` : '';
        return `
          <div class="welcome-grid">
            <div class="welcome-left"><div class="welcome-hero">${heroImage}</div></div>
            <div class="welcome-right">
              <div class="welcome-title">Bienvenido</div>
              <div class="welcome-user-name">${nombre}</div>
              <div class="welcome-user-initials">Iniciales: ${iniciales}</div>
              ${avisoOpen}
              ${ultimaHtml}
            </div>
          </div>
          <div class="welcome-section">
            <div class="actions-center"><p class="muted">Selecciona la empresa con la que trabajarás:</p></div>
            <div class="actions actions-center" id="selectorEmpresas">${botones}</div>
          </div>
        `;
      }

      function renderJornadaCerrada(ultima, allowOpen){
        const ahoraId = 'relojAhora';
        const ultimaHtml = ultima ? `
          <div class="welcome-last">
            <div class="last-title">Última jornada</div>
            <div class="last-grid">
              <div><span>Empresa:</span> <strong>${ultima.empresa}</strong></div>
              <div><span>Entrada:</span> ${ultima.horaEntrada.toLocaleString()}</div>
              <div><span>Salida:</span> ${ultima.horaSalida.toLocaleString()}</div>
              <div><span>Duración:</span> ${Math.max(0, Math.floor(ultima.duracionMs/3600000))}h ${Math.floor((ultima.duracionMs%3600000)/60000)}m</div>
            </div>
          </div>
        ` : '';
        const botonAbrir = allowOpen ? `<button class="btn btn-primary-large" id="btnAbrir">Abrir Jornada</button>` : '';
        const avisoOpen = !allowOpen ? `<div class="notice-open">Ya tienes una jornada abierta. Cierra tu jornada actual para abrir otra.</div>` : '';
        return `
          <div class="welcome-grid">
            <div class="welcome-left"><div class="welcome-hero">${heroImage}</div></div>
            <div class="welcome-right">
              <div class="welcome-title">Bienvenido</div>
              <div class="welcome-user-name">${nombre}</div>
              <div class="welcome-user-initials">Iniciales: ${iniciales}</div>
              <div class="clock-container"><div id="${ahoraId}" class="clock-large">--:--:--</div></div>
              <div class="centered-actions">${botonAbrir}</div>
              ${avisoOpen}
              ${ultimaHtml}
            </div>
          </div>
          <div class="actions actions-center" style="margin-top:12px">${botonesPaginas}</div>
        `;
      }

      function renderJornadaAbierta(info){
        const inicio = info?.horaEntrada && info.horaEntrada.toDate ? info.horaEntrada.toDate() : new Date();
        const inicioISO = inicio.toLocaleString();
        const timerId = 'timerJornada';
        return `
          <div class="welcome-grid">
            <div class="welcome-left"><div class="welcome-hero">${heroImage}</div></div>
            <div class="welcome-right">
              <div class="welcome-title">Jornada abierta</div>
              <div class="welcome-user-name">${nombre}</div>
              <div class="welcome-user-initials">Iniciales: ${iniciales}</div>
              <div class="clock-container"><div id="${timerId}" class="clock-large">00:00:00</div></div>
              <div class="centered-actions">
                <button class="btn btn-danger-large" id="btnCerrar">Cerrar Jornada</button>
              </div>
              <div class="muted" style="margin-top:8px;text-align:center">Entrada: ${inicioISO} · Empresa: ${empresaSel||'(selecciona)'} </div>
            </div>
          </div>
          <div class="actions actions-center" style="margin-top:12px">${botonesPaginas}</div>
        `;
      }

      // Decidir modo
      const modo = estado.modo; // 'selector' | 'cerrada' | 'abierta'
      if (modo === 'selector') {
        modal.innerHTML = renderSelector(estado);
        // Eventos selector
        const cont = modal.querySelector('#selectorEmpresas');
        cont.querySelectorAll('button[data-empresa]').forEach(btn => {
          btn.addEventListener('click', () => {
            const nombreEmp = btn.getAttribute('data-empresa');
            const roles = activas.find(e => e?.nombre === nombreEmp)?.rol || [];
            setEmpresaSeleccionadaEnSesion(nombreEmp, roles);
            showToast('Empresa seleccionada: ' + nombreEmp, 'success');
            const sesNow = JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session'));
            if (estado?.openInfo) {
              // Jornada abierta en otra empresa: mostrar modo abierta y NO permitir abrir otra
              renderBienvenida(backdrop, sesNow, { modo: 'abierta', info: estado.openInfo });
              iniciarTimer(modal.querySelector('#timerJornada'), estado.openInfo?.horaEntrada);
              window.bindCerrar(modal.querySelector('#btnCerrar'));
            } else {
              // Re-render a jornada cerrada
              renderBienvenida(backdrop, sesNow, { modo: 'cerrada' });
              iniciarReloj(modal.querySelector('#relojAhora'));
              window.bindAbrir(modal.querySelector('#btnAbrir'), nombreEmp);
            }
          });
        });
      } else if (modo === 'cerrada') {
        modal.innerHTML = renderJornadaCerrada(null, true);
        iniciarReloj(modal.querySelector('#relojAhora'));
        const nombreEmp = empresaSel || (activas.length===1 ? activas[0].nombre : null);
        window.bindAbrir(modal.querySelector('#btnAbrir'), nombreEmp);
        // Cargar última jornada cerrada
        try {
          if (window.firestoreManager && typeof window.firestoreManager.getUltimaJornada === 'function'){
            window.firestoreManager.getUltimaJornada(ses.iniciales).then(ultima => {
              // Si el modo cambió mientras llegaba la respuesta, no re-renderizar
              if (backdrop.dataset.mode !== 'cerrada') return;
              if (!ultima) return;
              renderBienvenida(backdrop, ses, { modo: 'cerrada', ultima });
              iniciarReloj(modal.querySelector('#relojAhora'));
              window.bindAbrir(modal.querySelector('#btnAbrir'), nombreEmp);
            });
          }
        } catch {}
      } else if (modo === 'abierta') {
        modal.innerHTML = renderJornadaAbierta(estado.info);
        iniciarTimer(modal.querySelector('#timerJornada'), estado.info?.horaEntrada);
        window.bindCerrar(modal.querySelector('#btnCerrar'));
      }

      function iniciarReloj(el){
        if (!el) return;
        const tick = () => {
          const d = new Date();
          el.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        };
        tick();
        const iv = setInterval(tick, 1000);
        backdrop._clockInterval = iv;
      }
      function iniciarTimer(el, ts){
        if (!el) return;
        const inicio = ts && ts.toDate ? ts.toDate().getTime() : Date.now();
        const tick = () => { el.textContent = formatoTiempo(Date.now() - inicio); };
        tick();
        const iv = setInterval(tick, 1000);
        backdrop._timerInterval = iv;
      }

      // Nota: bindAbrir/bindCerrar y showLoadingModal ahora son globales (window.*)
    }

    // Inicio: mostrar BIENVENIDA (render inmediato + actualización en background)
    try {
      await waitForFirestoreManager(12000);
      const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
      const ses = s ? JSON.parse(s) : null;
      if (!ses || !ses.iniciales){
        // redirección ya la manejó el bloque anterior
      } else {
        const backdrop = crearBackdrop();
        window._welcomeBackdrop = backdrop;
        const activas = getEmpresaActivas(ses);
        const params = new URLSearchParams(window.location.search);
        const forceSelector = params.get('mode') === 'selector';

        // 1) Render inmediato
        if (forceSelector) {
          renderBienvenida(backdrop, ses, { modo:'selector' });
        } else if (activas.length === 1) {
          const unica = activas[0];
          setEmpresaSeleccionadaEnSesion(unica.nombre, unica.rol || []);
          renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'cerrada' });
          const el = backdrop.querySelector('#relojAhora');
          if (el) { const tick = () => { const d = new Date(); el.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }; tick(); backdrop._clockInterval = setInterval(tick, 1000); }
          const btn = backdrop.querySelector('#btnAbrir');
          if (btn) { window.bindAbrir(btn, unica.nombre); }
        } else {
          renderBienvenida(backdrop, ses, { modo:'selector' });
        }

        // 2) Actualización en background (estado real de jornada + última jornada)
        (async () => {
          try {
            const openInfo = await window.firestoreManager.getJornadaAbierta(ses.iniciales);
            if (openInfo) {
              // Si el botón "Cambiar" forzó el selector, NO cambies a modo abierta
              if (backdrop.dataset && backdrop.dataset.forceSelector === '1') {
                // Continuar para cargar "última jornada" en modo selector
              } else {
                const rolesOpen = (activas.find(e => e?.nombre === openInfo.empresaNombre)?.rol) || [];
                setEmpresaSeleccionadaEnSesion(openInfo.empresaNombre, rolesOpen);
                renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'abierta', info: openInfo });
                const el = backdrop.querySelector('#timerJornada');
                if (el) { const ts = openInfo?.horaEntrada; const inicio = ts && ts.toDate ? ts.toDate().getTime() : Date.now(); const tick = () => { el.textContent = formatoTiempo(Date.now() - inicio); }; tick(); backdrop._timerInterval = setInterval(tick,1000); }
                window.bindCerrar(backdrop.querySelector('#btnCerrar'));
                return; // si hay jornada abierta, no necesitamos cargar "última"
              }
            }

            // Si no hay jornada abierta, cargar "última jornada" según el modo
            if (window.firestoreManager && typeof window.firestoreManager.getUltimaJornada === 'function') {
              const ultima = await window.firestoreManager.getUltimaJornada(ses.iniciales);
              if (!ultima) return;
              if (activas.length === 1) {
                if (backdrop.dataset.mode !== 'cerrada') return;
                renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'cerrada', ultima });
                const relojj = backdrop.querySelector('#relojAhora');
                if (relojj){ const tick = () => { const d = new Date(); relojj.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }; tick(); backdrop._clockInterval = setInterval(tick, 1000); }
                const unica = activas[0];
                window.bindAbrir(backdrop.querySelector('#btnAbrir'), unica?.nombre || null);
              } else {
                if (backdrop.dataset.mode !== 'selector' && !(backdrop.dataset && backdrop.dataset.forceSelector === '1')) return;
                renderBienvenida(backdrop, ses, { modo:'selector', ultima });
              }
            }
          } catch {}
        })();
      }
    } catch (e){ console.warn('No se pudo abrir BIENVENIDA:', e); showToast('Inicializando… intenta de nuevo en unos segundos', 'warning'); }

    // Escuchar cambios de jornada desde el header y actualizar el modal
    window.addEventListener('jornadaChanged', async (ev) => {
      try {
        const s = sessionStorage.getItem('ls_session') || localStorage.getItem('ls_session');
        const ses = s ? JSON.parse(s) : null;
        if (!ses || !ses.iniciales) return;
        await waitForFirestoreManager(8000);
        const backdrop = window._welcomeBackdrop || crearBackdrop();
        window._welcomeBackdrop = backdrop;
        // limpiar timers previos
        if (backdrop._clockInterval) { clearInterval(backdrop._clockInterval); backdrop._clockInterval = null; }
        if (backdrop._timerInterval) { clearInterval(backdrop._timerInterval); backdrop._timerInterval = null; }
        const activas = getEmpresaActivas(ses);
        const detail = ev?.detail || {};
        // Si el evento indica cierre, actualizar UI inmediatamente a "cerrada" o "selector"
        if (detail.status === 'closed') {
          if (activas.length > 1) {
            // Múltiples empresas: forzar selector y cargar última jornada
            renderBienvenida(backdrop, ses, { modo:'selector' });
            try {
              if (window.firestoreManager && typeof window.firestoreManager.getUltimaJornada === 'function'){
                const ultima = await window.firestoreManager.getUltimaJornada(ses.iniciales);
                if (backdrop.dataset.mode === 'selector' && ultima) {
                  renderBienvenida(backdrop, ses, { modo:'selector', ultima });
                }
              }
            } catch {}
          } else {
            // Una sola empresa: modo cerrada + reloj + última jornada
            renderBienvenida(backdrop, ses, { modo:'cerrada' });
            iniciarReloj(backdrop.querySelector('#relojAhora'));
            const unica = activas[0];
            try { setEmpresaSeleccionadaEnSesion(unica?.nombre || null, unica?.rol || []); } catch {}
            window.bindAbrir(backdrop.querySelector('#btnAbrir'), unica?.nombre || null);
            try {
              if (window.firestoreManager && typeof window.firestoreManager.getUltimaJornada === 'function'){
                const ultima = await window.firestoreManager.getUltimaJornada(ses.iniciales);
                if (backdrop.dataset.mode === 'cerrada' && ultima) {
                  renderBienvenida(backdrop, ses, { modo:'cerrada', ultima });
                  iniciarReloj(backdrop.querySelector('#relojAhora'));
                  window.bindAbrir(backdrop.querySelector('#btnAbrir'), unica?.nombre || null);
                }
              }
            } catch {}
          }
          return; // Ya actualizamos UI por cierre; no consultar abierta
        }
        // Si el evento indica apertura inmediatamente, actualizar UI sin esperar consulta
        if (detail.status === 'open') {
          if (backdrop.dataset && backdrop.dataset.forceSelector === '1') {
            // Selector forzado: no cambiar a "abierta" aquí
          } else {
          const empresaNombre = detail.empresaNombre || ses?.empresaSeleccionada?.nombre || null;
          const rolesOpen = (activas.find(e => e?.nombre === empresaNombre)?.rol) || [];
          setEmpresaSeleccionadaEnSesion(empresaNombre, rolesOpen);
          renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'abierta', info: { horaEntrada: { toDate: () => new Date() } } });
          iniciarTimer(backdrop.querySelector('#timerJornada'), { toDate: () => new Date() });
          window.bindCerrar(backdrop.querySelector('#btnCerrar'));
          // Refrescar con datos reales en background
          try {
            const realOpen = await window.firestoreManager.getJornadaAbierta(ses.iniciales);
            if (realOpen){
              if (backdrop.dataset.mode !== 'abierta') return;
              renderBienvenida(backdrop, ses, { modo:'abierta', info: realOpen });
              iniciarTimer(backdrop.querySelector('#timerJornada'), realOpen?.horaEntrada);
              window.bindCerrar(backdrop.querySelector('#btnCerrar'));
            }
          } catch {}
          return;
          }
        }
        const openInfo = await window.firestoreManager.getJornadaAbierta(ses.iniciales);
        if (openInfo){
          if (backdrop.dataset && backdrop.dataset.forceSelector === '1') {
            // Mantener selector si fue forzado por el botón Cambiar
          } else {
          const rolesOpen = (activas.find(e => e?.nombre === openInfo.empresaNombre)?.rol) || [];
          setEmpresaSeleccionadaEnSesion(openInfo.empresaNombre, rolesOpen);
          renderBienvenida(backdrop, JSON.parse(sessionStorage.getItem('ls_session')||localStorage.getItem('ls_session')), { modo:'abierta', info: openInfo });
          iniciarTimer(backdrop.querySelector('#timerJornada'), openInfo?.horaEntrada);
          window.bindCerrar(backdrop.querySelector('#btnCerrar'));
          }
        } else {
          if (activas.length > 1){
            try {
              if (window.firestoreManager && typeof window.firestoreManager.getUltimaJornada === 'function'){
                const ultima = await window.firestoreManager.getUltimaJornada(ses.iniciales);
                if (backdrop.dataset.mode === 'abierta') return; // si cambió recientemente
                renderBienvenida(backdrop, ses, { modo:'selector', ultima });
              } else {
                renderBienvenida(backdrop, ses, { modo:'selector' });
              }
            } catch {
              renderBienvenida(backdrop, ses, { modo:'selector' });
            }
          } else {
            renderBienvenida(backdrop, ses, { modo:'cerrada' });
            iniciarReloj(backdrop.querySelector('#relojAhora'));
            const unica = activas[0];
            try { setEmpresaSeleccionadaEnSesion(unica?.nombre || null, unica?.rol || []); } catch {}
            window.bindAbrir(backdrop.querySelector('#btnAbrir'), unica?.nombre || null);
            try {
              if (window.firestoreManager && typeof window.firestoreManager.getUltimaJornada === 'function'){
                const ultima = await window.firestoreManager.getUltimaJornada(ses.iniciales);
                if (ultima){
                  if (backdrop.dataset.mode !== 'cerrada') return;
                  renderBienvenida(backdrop, ses, { modo:'cerrada', ultima });
                  iniciarReloj(backdrop.querySelector('#relojAhora'));
                  window.bindAbrir(backdrop.querySelector('#btnAbrir'), unica?.nombre || null);
                }
              }
            } catch {}
          }
        }
      } catch {}
    });
  </script>
  <!-- La versión se establece en el script de carga secuencial arriba -->
</body>
</html>