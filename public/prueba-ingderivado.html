<!DOCTYPE html>
<html lang="es" data-include-header="true">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Prueba Ingreso Derivado ‚Äî LedroitCheck</title>
    <link rel="icon" type="image/svg+xml" href="./assets/logo-ledroitcheck.svg" />
    <link rel="stylesheet" href="assets/global-header.css" />
    <script src="assets/global-header.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .tabs { display: flex; background: white; border-radius: 10px 10px 0 0; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px 20px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: white; color: #667eea; }
        .tab:hover { background: #e9ecef; }
        .tab.active:hover { background: white; }
        .content { background: white; border-radius: 0 0 10px 10px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .section { display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .btn { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; margin: 5px; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn.secondary { background: #6c757d; }
        .btn.secondary:hover { background: #5a6268; }
        .btn.success { background: #28a745; }
        .btn.success:hover { background: #218838; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.warning:hover { background: #e0a800; }
        .log-area { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9rem; margin-top: 20px; }
        .log-entry { margin-bottom: 5px; padding: 5px; border-radius: 4px; }
        .log-info { color: #0066cc; }
        .log-success { color: #28a745; background: #d4edda; }
        .log-error { color: #dc3545; background: #f8d7da; }
        .log-warning { color: #856404; background: #fff3cd; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f8f9fa; border-radius: 8px; padding: 20px; border: 2px solid #e9ecef; }
        .card h3 { color: #667eea; margin-bottom: 15px; }
        .session-info { background: #e7f3ff; border: 2px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .json-input { height: 200px; font-family: 'Courier New', monospace; }
        .json-output { height: 300px; font-family: 'Courier New', monospace; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; overflow-y: auto; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .alert-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .alert-warning { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }
        .alert-error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
        .no-session { text-align: center; padding: 40px; }
        .no-session h2 { color: #dc3545; margin-bottom: 20px; }
        .no-session p { margin-bottom: 20px; color: #666; }
        
        /* Estilos para toasts */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            padding: 16px;
            border-left: 4px solid #007bff;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.info {
            border-left-color: #17a2b8;
        }

        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .toast-body {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            padding: 0;
            margin-left: 10px;
        }

        .toast-close:hover {
            color: #333;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(0,0,0,0.1);
            width: 100%;
            transform-origin: left;
            animation: toast-progress 4s linear;
        }

        @keyframes toast-progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        .toast.success .toast-progress {
            background: #28a745;
        }

        .toast.error .toast-progress {
            background: #dc3545;
        }

        .toast.warning .toast-progress {
            background: #ffc107;
        }

        .toast.info .toast-progress {
            background: #17a2b8;
        }
    /* Responsive */
            @media (max-width: 768px) {
                .container {
                    margin: 10px;
                    padding: 15px;
                }
                
                .tabs {
                    flex-direction: column;
                }
                
                .tab {
                    margin-bottom: 5px;
                }
                
                .form-row {
                    flex-direction: column;
                }
                
                .form-group {
                    margin-right: 0;
                    margin-bottom: 15px;
                }

                .toast-container {
                    top: 10px;
                    right: 10px;
                    left: 10px;
                    max-width: none;
                }
    </style>
</head>
<body>
    <!-- Contenedor de toasts -->
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="container">
        <div class="header">
            <h1>üß™ Prueba Ingreso Derivado</h1>
            <p>Herramienta para probar ingresos derivados activos y pasivos en sistemas de la Familia Ledroit</p>
        </div>

        <!-- Verificaci√≥n de sesi√≥n -->
        <div id="noSessionAlert" class="no-session" style="display: none;">
            <div class="alert alert-error">
                <h2>üîí Acceso Restringido</h2>
                <p>Debes estar autenticado para usar esta herramienta de pruebas.</p>
                <p>Por favor, inicia sesi√≥n primero en el sistema.</p>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="window.location.href='login.html'">üîë Ir al Login</button>
                </div>
            </div>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('activo')">üöÄ Modo ACTIVO</button>
                <button class="tab" onclick="switchTab('pasivo')">üì• Modo PASIVO</button>
                <button class="tab" onclick="switchTab('info')">üìã Informaci√≥n</button>
            </div>

            <div class="content">
                <!-- MODO ACTIVO -->
                <div id="activo" class="section active">
                    <h2>üöÄ Ingreso Derivado ACTIVO</h2>
                    <p>Env√≠a usuarios desde este sistema hacia otros sistemas de la familia Ledroit.</p>

                    <div class="session-info">
                        <h3>üìã Sesi√≥n Actual</h3>
                        <div id="sessionInfo">Cargando informaci√≥n de sesi√≥n...</div>
                    </div>

                    <div class="grid">
                        <div class="card">
                            <h3>üéØ Configuraci√≥n de Env√≠o</h3>
                            <div class="form-group">
                                <label for="urlDestino">URL del Sistema Destino</label>
                                <input type="url" id="urlDestino" placeholder="https://ejemplo.web.app/ingreso-derivado">
                            </div>
                            <div class="form-group">
                                <label for="sistemaDestino">Nombre del Sistema Destino</label>
                                <input type="text" id="sistemaDestino" placeholder="NOMBRE_SISTEMA_DESTINO">
                            </div>
                            <button class="btn" onclick="enviarIngresoDerivado()">üöÄ Enviar Usuario</button>
                        </div>

                        <div class="card">
                            <h3>‚öôÔ∏è Opciones Avanzadas</h3>
                            <div class="form-group">
                                <label for="metodoEnvio">M√©todo de Env√≠o</label>
                                <select id="metodoEnvio">
                                    <option value="post">POST con formulario (Est√°ndar Ledroit)</option>
                                </select>
                            </div>
                            <button class="btn warning" onclick="generarJSON()">üìã Generar JSON</button>
                        </div>
                    </div>
                </div>

                <!-- MODO PASIVO -->
                <div id="pasivo" class="section">
                    <h2>üì• Ingreso Derivado PASIVO</h2>
                    <p>Simula la recepci√≥n de usuarios desde otros sistemas de la familia Ledroit.</p>

                    <div class="alert alert-info">
                        <strong>üí° Instrucciones:</strong> Pega el JSON que recibir√≠as de otro sistema y prueba el procesamiento.
                    </div>

                    <div class="form-group">
                        <label for="jsonInput">JSON de Prueba (respuestaLMaster)</label>
                        <textarea id="jsonInput" class="json-input" placeholder="Pega aqu√≠ el JSON de respuestaLMaster que recibir√≠as de otro sistema..."></textarea>
                    </div>

                    <div class="form-group">
                        <button class="btn success" onclick="actualizarTimestamp()">‚è∞ Actualizar Timestamp</button>
                        <button class="btn" onclick="testIngresoDerivadoPasivo()">üß™ Probar Ingreso Pasivo</button>
                        <button class="btn secondary" onclick="enviarAIngresoDerivado()">üì§ Enviar al endpoint /ingreso-derivado (POST)</button>
                    </div>
                </div>

                <!-- INFORMACI√ìN -->
                <div id="info" class="section">
                    <h2>üìã Informaci√≥n del Sistema</h2>
                    
                    <div class="alert alert-info">
                        <h3>üéØ Prop√≥sito de esta Herramienta</h3>
                        <p>Esta p√°gina permite probar ambos modos de ingreso derivado:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>ACTIVO:</strong> Tu sistema env√≠a usuarios a otros sistemas</li>
                            <li><strong>PASIVO:</strong> Tu sistema recibe usuarios de otros sistemas</li>
                        </ul>
                    </div>

                    <div class="grid">
                        <div class="card">
                            <h3>üöÄ Modo ACTIVO</h3>
                            <p><strong>¬øCu√°ndo usar?</strong> Cuando un usuario en tu sistema quiere acceder a otro sistema de la familia Ledroit.</p>
                            <p><strong>¬øQu√© hace?</strong> Obtiene los datos del √∫ltimo ingreso satisfactorio y los env√≠a al sistema destino.</p>
                            <p><strong>Endpoints estandarizados:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li><strong>POST (obligatorio):</strong> <code>/ingreso-derivado</code> ‚Üê usar para enviar con formulario</li>
                                <li><strong>P√°gina de procesamiento (GET):</strong> <code>/ingreso-derivado.html</code> ‚Üê muestra resultados si llega por URL</li>
                            </ul>
                        </div>

                        <div class="card">
                            <h3>üì• Modo PASIVO</h3>
                            <p><strong>¬øCu√°ndo usar?</strong> Para probar c√≥mo tu sistema procesar√≠a una solicitud de ingreso derivado.</p>
                            <p><strong>¬øQu√© hace?</strong> Simula la recepci√≥n y validaci√≥n de datos de respuestaLMaster.</p>
                            <p><strong>Validaciones:</strong> Timestamp, empresas activas, metainformaci√≥n.</p>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <h3>‚ö†Ô∏è Importante</h3>
                        <p>Esta es una herramienta de <strong>desarrollo y pruebas</strong>. En producci√≥n, los ingresos derivados deben manejarse autom√°ticamente seg√∫n la documentaci√≥n oficial.</p>
                    </div>
                </div>

                <!-- √ÅREA DE LOGS -->
                <div class="form-group">
                    <label>üìã Logs de Actividad</label>
                    <div id="logArea" class="log-area">
                        <div class="log-entry log-info">[Inicio] Herramienta de prueba cargada correctamente</div>
                    </div>
                    <button class="btn secondary" onclick="clearLogs()">üßπ Limpiar Logs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts al final del body para evitar errores de carga -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="./assets/firebase-init.js"></script>
    <script>
        // Variables globales
        let currentTab = 'activo';
        let sessionData = null;

        // Verificar sesi√≥n al cargar
        window.addEventListener('DOMContentLoaded', function() {
            verificarSesion();
        });

        function verificarSesion() {
            // Leer sesi√≥n solo desde sessionStorage (como en menu.html)
            let session = null;
            try {
                const raw = sessionStorage.getItem('ls_session');
                session = raw ? JSON.parse(raw) : null;
            } catch {}

            const tieneIniciales = !!(session && session.iniciales);
            if (!tieneIniciales) {
                // Comportamiento igual que en menu.html: redirigir a login
                window.location.replace('login.html');
                return false;
            }

            // Sesi√≥n v√°lida
            sessionData = session;
            document.getElementById('noSessionAlert').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            cargarInformacionSesion();
            log('üöÄ Herramienta de prueba cargada', 'success');
            return true;
        }

        function cargarInformacionSesion() {
            const sessionInfo = document.getElementById('sessionInfo');
            
            if (sessionData && sessionData.iniciales) {
                // Estructura est√°ndar de sesi√≥n: ls_session con claves en espa√±ol
                const userData = {
                    iniciales: sessionData.iniciales,
                    nombre: sessionData.nombre,
                    foto_url: sessionData.foto_url || ''
                };
                let empresas = Array.isArray(sessionData.empresas) ? sessionData.empresas : [];
                
                const empresasActivas = empresas.filter(emp => emp.empresa_activa && emp.usuario_activo);
                
                sessionInfo.innerHTML = `
                    <strong>üë§ Usuario:</strong> ${userData.iniciales}<br>
                    
                    <strong>‚è∞ Sesi√≥n iniciada:</strong> ${new Date(sessionData.timestamp).toLocaleString()}<br>
                    <strong>üè¢ Empresas totales:</strong> ${empresas.length}<br>
                    <strong>‚úÖ Empresas activas:</strong> ${empresasActivas.length}<br>
                    <strong>üìã Empresas:</strong> ${empresasActivas.map(emp => emp.nombre).join(', ') || 'Ninguna activa'}
                `;
                 log(`üìã Sesi√≥n cargada: ${userData.iniciales} (${empresasActivas.length} empresas activas)`, 'info');
            } else {
                sessionInfo.innerHTML = '<span style="color: #dc3545;">‚ùå Error cargando datos de sesi√≥n</span>';
                log('‚ö†Ô∏è Error cargando datos de sesi√≥n', 'warning');
            }
        }

        // Funciones de navegaci√≥n
        function switchTab(tabName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover clase active de todos los tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(tabName).classList.add('active');
            
            // Activar tab seleccionado
            event.target.classList.add('active');
            
            currentTab = tabName;
            log(`üìã Cambiado a modo: ${tabName.toUpperCase()}`, 'info');
        }

        // Sistema de toasts
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const toastId = 'toast_' + Date.now();
            toast.id = toastId;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const titles = {
                success: '√âxito',
                error: 'Error',
                warning: 'Advertencia',
                info: 'Informaci√≥n'
            };
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span>${icons[type]} ${titles[type]}</span>
                    <button class="toast-close" onclick="closeToast('${toastId}')">&times;</button>
                </div>
                <div class="toast-body">${message}</div>
                <div class="toast-progress"></div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Mostrar toast con animaci√≥n
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto-cerrar despu√©s del tiempo especificado
            setTimeout(() => {
                closeToast(toastId);
            }, duration);
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        // Sistema de logs
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${className}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logArea').innerHTML = '<div class="log-entry log-info">[Inicio] Logs limpiados</div>';
        }

        // MODO ACTIVO - Funciones
        async function enviarIngresoDerivado() {
            log('üöÄ Iniciando env√≠o de ingreso derivado...', 'info');
            
            try {
                const urlDestino = document.getElementById('urlDestino').value;
                const sistemaDestino = document.getElementById('sistemaDestino').value;

                if (!urlDestino) {
                    log('‚ùå URL destino requerida', 'error');
                    return;
                }

                if (!sistemaDestino) {
                    log('‚ùå Nombre del sistema destino requerido', 'error');
                    return;
                }

                // Obtener datos de sesi√≥n actual
                const respuestaLMaster = await obtenerDatosParaEnvio(sistemaDestino);
                if (!respuestaLMaster) {
                    log('‚ùå No se pudieron obtener los datos para env√≠o', 'error');
                    return;
                }

                log(`üì§ Enviando a: ${urlDestino}`, 'info');
                log(`üéØ Sistema destino: ${sistemaDestino}`, 'info');
                log(`üìã M√©todo: POST con formulario (Est√°ndar Ledroit)`, 'info');

                enviarPorURL(urlDestino, respuestaLMaster);

                log('‚úÖ Solicitud enviada correctamente', 'success');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function obtenerDatosParaEnvio(sistemaDestino) {
            if (!sessionData || !sessionData.iniciales) {
                throw new Error('No hay sesi√≥n activa');
            }

            // Estructura est√°ndar de sesi√≥n: ls_session con claves en espa√±ol
            const userData = {
                iniciales: sessionData.iniciales,
                nombre: sessionData.nombre,
                foto_url: sessionData.foto_url || ''
            };
            let empresas = Array.isArray(sessionData.empresas) ? sessionData.empresas : [];
            
            const empresasActivas = empresas.filter(emp => emp.empresa_activa && emp.usuario_activo);

            if (empresasActivas.length === 0) {
                throw new Error('No hay empresas activas en la sesi√≥n');
            }

            // Crear respuestaLMaster con datos reales de la sesi√≥n (formato compatible con test-ingreso-derivado.html)
            const respuestaLMaster = {
                success: true,
                error: null,
                data: {
                    iniciales: userData.iniciales,
                    nombre: userData.nombre || '',
                    foto_url: (userData.foto_url || '').toString().trim().replace(/^[\s`'\"]+/g, '').replace(/[\s`'\"]+$/g, '').replace(/`/g, ''),
                    empresas: empresasActivas.map(emp => ({
                        nombre: emp.nombre,
                        empresa_activa: emp.empresa_activa,
                        usuario_activo: emp.usuario_activo,
                        rol: emp.rol || ["A1"]
                    }))
                },
                timestamp: new Date().toISOString(),
                sistemaOrigen: "LEDROITCHECK",
                empresaSolicitante: empresasActivas[0].nombre
            };

            log(`üìã Datos obtenidos para: ${userData.iniciales}`, 'info');
            log(`üè¢ Empresa solicitante: ${empresasActivas[0].nombre}`, 'info');
            log(`üìä ${empresasActivas.length} empresas activas incluidas`, 'info');
            
            return respuestaLMaster;
        }

        function generarJSON() {
            try {
                obtenerDatosParaEnvio('SISTEMA_DESTINO').then(datos => {
                    // Crear modal con JSON formateado
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                        align-items: center; justify-content: center;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white; border-radius: 10px; padding: 30px; 
                        max-width: 80%; max-height: 80%; overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    `;
                    
                    // Crear bot√≥n de copiar con funci√≥n separada
                    const copiarBtn = document.createElement('button');
                    copiarBtn.textContent = 'üìã Copiar JSON';
                    copiarBtn.style.cssText = 'background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;';
                    copiarBtn.onclick = () => {
                        navigator.clipboard.writeText(JSON.stringify(datos)).then(() => {
                            showToast('JSON copiado al portapapeles', 'success');
                        }).catch(err => {
                            console.error('Error copiando:', err);
                            showToast('Error al copiar JSON', 'error');
                        });
                    };
                    
                    const cerrarBtn = document.createElement('button');
                    cerrarBtn.textContent = '‚ùå Cerrar';
                    cerrarBtn.style.cssText = 'background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;';
                    cerrarBtn.onclick = () => modal.remove();
                    
                    modalContent.innerHTML = `
                        <h3 style="margin-bottom: 20px; color: #667eea;">üìã JSON Generado</h3>
                        <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; margin: 0;">${JSON.stringify(datos, null, 2)}</pre>
                        </div>
                        <div style="text-align: right;" id="modal-buttons">
                        </div>
                    `;
                    
                    // Agregar botones al contenedor
                    const buttonsContainer = modalContent.querySelector('#modal-buttons');
                    buttonsContainer.appendChild(copiarBtn);
                    buttonsContainer.appendChild(cerrarBtn);
                    
                    modal.className = 'modal-overlay';
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Cerrar modal al hacer click fuera
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                    
                }).catch(error => {
                    log(`‚ùå Error generando JSON: ${error.message}`, 'error');
                });
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function enviarPorURL(urlDestino, respuestaLMaster) {
            // Normalizar destino: si apunta a ingreso-derivado.html ‚áí usar el endpoint /ingreso-derivado
            let destinoNormalizado = urlDestino;
            try {
                const u = new URL(urlDestino, window.location.origin);
                if (/\/?ingreso-derivado\.html$/i.test(u.pathname)) {
                    u.pathname = u.pathname.replace(/ingreso-derivado\.html$/i, 'ingreso-derivado');
                    destinoNormalizado = u.toString();
                } else {
                    destinoNormalizado = u.toString();
                }
            } catch (e) {
                destinoNormalizado = urlDestino.replace(/ingreso-derivado\.html$/i, 'ingreso-derivado');
            }

            // Crear formulario temporal para env√≠o POST
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = destinoNormalizado;
            form.target = '_blank';
            form.style.display = 'none';
            
            // Crear campo oculto con los datos
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'respuestaLMaster';
            input.value = JSON.stringify(respuestaLMaster);
            
            form.appendChild(input);
            document.body.appendChild(form);
            
            // Enviar formulario
            form.submit();
            
            // Limpiar formulario temporal
            document.body.removeChild(form);
            
            showToast('Usuario enviado correctamente por POST', 'success');
        }

        function verDatosAEnviar() {
            const sistemaDestino = document.getElementById('sistemaDestino').value || 'SISTEMA_DESTINO';
            
            obtenerDatosParaEnvio(sistemaDestino).then(datos => {
                log('üëÅÔ∏è Datos que se enviar√≠an:', 'info');
                log(JSON.stringify(datos, null, 2), 'info');
            }).catch(error => {
                log(`‚ùå Error obteniendo datos: ${error.message}`, 'error');
            });
        }

        // MODO PASIVO - Funciones
        function actualizarTimestamp() {
            const jsonInput = document.getElementById('jsonInput');
            
            if (!jsonInput.value.trim()) {
                log('‚ùå No hay JSON para actualizar', 'error');
                return;
            }
            
            try {
                const jsonData = JSON.parse(jsonInput.value);
                jsonData.timestamp = new Date().toISOString();
                jsonInput.value = JSON.stringify(jsonData, null, 2);
                log('‚úÖ Timestamp actualizado a: ' + jsonData.timestamp, 'success');
            } catch (error) {
                log('‚ùå Error actualizando timestamp: JSON inv√°lido', 'error');
            }
        }

        function testIngresoDerivadoPasivo() {
            log('üß™ Iniciando prueba de ingreso derivado pasivo...', 'info');

            const jsonInputValue = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInputValue) {
                log('‚ùå Debes pegar un JSON de prueba primero', 'error');
                return;
            }

            try {
                const respuestaLMaster = JSON.parse(jsonInputValue);
                
                log('üì• JSON parseado correctamente', 'success');

                // Validar estructura b√°sica (compatible con ambos formatos)
                let userData = null;
                if (respuestaLMaster.RESPUESTALEDROIMASTER && respuestaLMaster.RESPUESTALEDROIMASTER.data) {
                    // Formato con RESPUESTALEDROIMASTER
                    userData = respuestaLMaster.RESPUESTALEDROIMASTER.data;
                } else if (respuestaLMaster.data) {
                    // Formato directo
                    userData = respuestaLMaster.data;
                } else {
                    log('‚ùå Estructura de datos incompleta o inv√°lida', 'error');
                    return;
                }

                if (!userData.iniciales) {
                    log('‚ùå Datos incompletos: falta iniciales', 'error');
                    return;
                }

                log(`üîç Usuario: ${userData.iniciales}`, 'info');

                // Validar timestamp
                if (respuestaLMaster.timestamp) {
                    const timestamp = new Date(respuestaLMaster.timestamp);
                    const ahora = new Date();
                    const minutosTranscurridos = (ahora - timestamp) / (1000 * 60);
                    
                    log(`‚è∞ Minutos transcurridos: ${minutosTranscurridos.toFixed(2)}`, 'info');
                    
                    if (minutosTranscurridos > 15) {
                        log('‚ùå Timestamp muy antiguo (>15 minutos)', 'error');
                        return;
                    }
                }

                // Validar empresas
                const empresas = userData.empresas || [];
                const tieneEmpresaActiva = empresas.some(emp => emp.empresa_activa && emp.usuario_activo);
                
                log(`üë§ Empresas encontradas: ${empresas.length}`, 'info');
                log(`‚úÖ Tiene empresa activa: ${tieneEmpresaActiva}`, tieneEmpresaActiva ? 'success' : 'error');

                if (!tieneEmpresaActiva) {
                    log('‚ùå No tiene empresas activas', 'error');
                    return;
                }

                // Validar metainformaci√≥n
                const metaInfo = {
                    sistemaActivo: respuestaLMaster.sistemaActivo || respuestaLMaster.sistemaOrigen || 'SISTEMA_DESCONOCIDO',
                    timestamp: respuestaLMaster.timestamp,
                    iniciales: userData.iniciales
                };

                log(`üîç Sistema origen: ${metaInfo.sistemaActivo}`, 'info');
                log(`üìã Metainformaci√≥n v√°lida: ‚úÖ`, 'success');

                log('‚úÖ Todas las validaciones pasaron', 'success');
                log('üéâ El ingreso derivado ser√≠a EXITOSO', 'success');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function enviarAIngresoDerivado() {
            log('üì§ Enviando al endpoint /ingreso-derivado (POST)...', 'info');

            const jsonInputValue = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInputValue) {
                log('‚ùå Debes pegar un JSON de prueba primero', 'error');
                return;
            }

            try {
                const respuestaLMaster = JSON.parse(jsonInputValue);
                
                // Log en la p√°gina de actividad
                log('ENV√çO PASIVO - Enviando datos al endpoint /ingreso-derivado por POST', 'info');
                log(`ENV√çO PASIVO - Datos enviados: ${JSON.stringify(respuestaLMaster).substring(0, 200)}...`, 'info');
                
                // Crear formulario temporal para env√≠o POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'ingreso-derivado';
                form.target = '_blank';
                form.style.display = 'none';
                
                // Crear campo oculto con los datos
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'respuestaLMaster';
                input.value = JSON.stringify(respuestaLMaster);
                
                form.appendChild(input);
                document.body.appendChild(form);
                
                // Log del m√©todo utilizado
                log('ENV√çO PASIVO - M√©todo POST con formulario utilizado (endpoint /ingreso-derivado)', 'info');
                
                // Enviar formulario
                form.submit();
                
                // Limpiar formulario temporal
                document.body.removeChild(form);
                
                showToast('Datos enviados al endpoint /ingreso-derivado por POST', 'success');
                log('ENV√çO PASIVO - Formulario enviado exitosamente', 'success');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>